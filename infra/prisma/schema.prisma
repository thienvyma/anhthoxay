datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// AUTH & USER MANAGEMENT
// ============================================

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String
  name           String
  role           String          @default("MANAGER") // ADMIN, MANAGER, WORKER, USER
  sessions       Session[]
  blogPosts      BlogPost[]
  pendingChanges PendingChange[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Session {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenSelector    String    @unique // Unhashed, indexed for O(1) lookup
  tokenVerifier    String    // Hashed with bcrypt
  token            String?   @unique // DEPRECATED: Keep for migration, nullable
  previousSelector String?   // Previous selector for reuse detection
  previousToken    String?   // DEPRECATED: Previous token hash for rotation detection
  userAgent        String?
  ipAddress        String?
  expiresAt        DateTime
  rotatedAt        DateTime? // Last rotation timestamp
  createdAt        DateTime  @default(now())

  @@index([tokenSelector])
}

// ============================================
// JWT ENHANCEMENT - TOKEN BLACKLIST
// ============================================

model TokenBlacklist {
  id        String   @id @default(cuid())
  tokenHash String   @unique // SHA256 hash of token
  userId    String
  reason    String   // logout, password_change, admin_revoke, security
  expiresAt DateTime // Auto-cleanup after token would expire
  createdAt DateTime @default(now())

  @@index([tokenHash])
  @@index([expiresAt])
  @@index([userId])
}

// ============================================
// JWT ENHANCEMENT - AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  eventType String   // LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, TOKEN_REFRESH, PASSWORD_CHANGE, etc.
  userId    String?
  email     String?
  ipAddress String
  userAgent String
  metadata  String?  // JSON string for additional context
  severity  String   @default("INFO") // INFO, WARNING, CRITICAL
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@index([severity])
}

// ============================================
// CMS - PAGES & SECTIONS
// ============================================

model Page {
  id           String    @id @default(cuid())
  slug         String    @unique
  title        String
  headerConfig String?
  footerConfig String?
  sections     Section[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Section {
  id        String   @id @default(cuid())
  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  kind      String
  order     Int
  data      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// MEDIA ASSETS
// ============================================

model MediaAsset {
  id           String   @id @default(cuid())
  url          String
  alt          String?
  caption      String?
  width        Int?
  height       Int?
  size         Int?
  mimeType     String?
  tags         String?
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// BLOG & SEO
// ============================================

model BlogCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  color       String?
  posts       BlogPost[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model BlogPost {
  id            String        @id @default(cuid())
  title         String
  slug          String        @unique
  excerpt       String?
  content       String
  featuredImage String?
  categoryId    String
  category      BlogCategory  @relation(fields: [categoryId], references: [id])
  authorId      String
  author        User          @relation(fields: [authorId], references: [id])
  tags          String?
  status        String        @default("DRAFT")
  isFeatured    Boolean       @default(false)
  publishedAt   DateTime?
  comments      BlogComment[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model BlogComment {
  id        String   @id @default(cuid())
  postId    String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  name      String
  email     String
  content   String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ============================================
// ATH - HẠNG MỤC THI CÔNG (Service Categories)
// ============================================

model ServiceCategory {
  id                 String                              @id @default(cuid())
  name               String                              @unique
  slug               String                              @unique
  description        String?
  icon               String?
  coefficient        Float                               @default(1.0)
  formulaId          String?
  formula            Formula?                            @relation(fields: [formulaId], references: [id])
  materialCategories ServiceCategoryMaterialCategory[]
  order              Int                                 @default(0)
  isActive           Boolean                             @default(true)
  createdAt          DateTime                            @default(now())
  updatedAt          DateTime                            @updatedAt
}

// ============================================
// ATH - ĐƠN GIÁ THI CÔNG (Unit Prices)
// ============================================

model UnitPrice {
  id          String   @id @default(cuid())
  category    String
  name        String
  price       Float
  tag         String   @unique
  unit        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([tag])
}

// ============================================
// ATH - DANH MỤC VẬT DỤNG (Material Categories)
// ============================================

model MaterialCategory {
  id                String                              @id @default(cuid())
  name              String                              @unique
  slug              String                              @unique
  description       String?
  icon              String?
  order             Int                                 @default(0)
  isActive          Boolean                             @default(true)
  materials         Material[]
  serviceCategories ServiceCategoryMaterialCategory[]
  createdAt         DateTime                            @default(now())
  updatedAt         DateTime                            @updatedAt
}

// ============================================
// ATH - VẬT DỤNG CƠ BẢN (Materials)
// ============================================

model Material {
  id          String            @id @default(cuid())
  name        String
  categoryId  String
  category    MaterialCategory  @relation(fields: [categoryId], references: [id])
  imageUrl    String?
  price       Float
  unit        String?
  description String?
  order       Int               @default(0)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([categoryId])
}

// Junction table for ServiceCategory <-> MaterialCategory (many-to-many)
model ServiceCategoryMaterialCategory {
  id                 String           @id @default(cuid())
  serviceCategoryId  String
  serviceCategory    ServiceCategory  @relation(fields: [serviceCategoryId], references: [id], onDelete: Cascade)
  materialCategoryId String
  materialCategory   MaterialCategory @relation(fields: [materialCategoryId], references: [id], onDelete: Cascade)

  @@unique([serviceCategoryId, materialCategoryId])
  @@index([serviceCategoryId])
  @@index([materialCategoryId])
}

// ============================================
// ATH - CÔNG THỨC TÍNH GIÁ (Formulas)
// ============================================

model Formula {
  id                String            @id @default(cuid())
  name              String
  expression        String
  description       String?
  serviceCategories ServiceCategory[]
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

// ============================================
// ATH - KHÁCH HÀNG / LEADS
// ============================================

model CustomerLead {
  id            String   @id @default(cuid())
  name          String
  phone         String
  email         String?
  content       String
  source        String   @default("CONTACT_FORM")
  status        String   @default("NEW")
  quoteData     String?
  notes         String?
  statusHistory String?  // JSON array of status changes: [{from, to, changedAt, changedBy?}]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([source])
  @@index([createdAt])
}

// ============================================
// ATH - PENDING CHANGES (Phân quyền)
// ============================================

model PendingChange {
  id          String    @id @default(cuid())
  entityType  String
  entityId    String
  changeType  String
  oldData     String?
  newData     String
  reason      String?
  status      String    @default("PENDING")
  requestedBy String
  requester   User      @relation(fields: [requestedBy], references: [id])
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([entityType])
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// INTEGRATIONS (Google Sheets, etc.)
// ============================================

model Integration {
  id          String    @id @default(cuid())
  type        String    @unique // google_sheets, etc.
  config      String    // JSON: { spreadsheetId, sheetName, syncEnabled }
  credentials String?   // Encrypted refresh token
  lastSyncAt  DateTime?
  errorCount  Int       @default(0)
  lastError   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}
