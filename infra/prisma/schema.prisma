datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// AUTH & USER MANAGEMENT
// ============================================

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String
  name           String
  phone          String?
  avatar         String?
  role           String          @default("MANAGER") // ADMIN, MANAGER, CONTRACTOR, HOMEOWNER, WORKER, USER
  
  // Contractor specific fields
  companyName        String?
  businessLicense    String?
  taxCode            String?
  verificationStatus String   @default("PENDING") // PENDING, VERIFIED, REJECTED
  verifiedAt         DateTime?
  verificationNote   String?  // Lý do từ chối (nếu có)
  rating             Float    @default(0)
  totalProjects      Int      @default(0)
  
  // Email unsubscribe token (Phase 4)
  unsubscribeToken   String?  @unique // Unique token for email unsubscribe
  
  // Relations
  contractorProfile  ContractorProfile?
  sessions           Session[]
  blogPosts          BlogPost[]
  pendingChanges     PendingChange[]
  
  // Bidding Phase 2 relations
  ownedProjects      Project[] @relation("ProjectOwner")
  contractorBids     Bid[]     @relation("ContractorBids")
  
  // Bidding Phase 3 relations
  feeTransactions    FeeTransaction[]
  notifications      Notification[]
  escrowsDeposited   Escrow[]  @relation("EscrowDepositor")
  
  // Bidding Phase 4 relations - Chat & Notifications
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]
  notificationPreference   NotificationPreference?
  
  // Bidding Phase 5 relations - Reviews & Ranking
  reviewsGiven       Review[]  @relation("ReviewAuthor")
  reviewsReceived    Review[]  @relation("ReviewSubject")
  ranking            ContractorRanking?
  badges             ContractorBadge[]
  reviewHelpfulVotes ReviewHelpfulness[]
  reviewReports      ReviewReport[]
  
  // Bidding Phase 6 relations - Saved Projects
  savedProjects      SavedProject[]
  
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([role])
  @@index([verificationStatus])
}

// ============================================
// CONTRACTOR PROFILE
// ============================================

model ContractorProfile {
  id          String @id @default(cuid())
  userId      String @unique
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Hồ sơ năng lực
  description     String?   // Giới thiệu
  experience      Int?      // Số năm kinh nghiệm
  specialties     String?   // JSON: ["Sơn", "Ốp lát", "Điện"]
  serviceAreas    String?   // JSON: ["region-id-1", "region-id-2"]
  portfolioImages String?   // JSON: ["url1", "url2"]
  certificates    String?   // JSON: [{name, imageUrl, issuedDate}]
  
  // Documents for verification
  idCardFront          String?
  idCardBack           String?
  businessLicenseImage String?
  
  // Submission tracking
  submittedAt     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// REGION (KHU VỰC)
// ============================================

model Region {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  parentId  String?
  parent    Region?  @relation("RegionHierarchy", fields: [parentId], references: [id])
  children  Region[] @relation("RegionHierarchy")
  
  level     Int      @default(1)  // 1: Tỉnh/TP, 2: Quận/Huyện, 3: Phường/Xã
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  
  // Bidding Phase 2 relations
  projects  Project[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([parentId])
  @@index([isActive])
  @@index([level])
}

model Session {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenSelector    String    @unique // Unhashed, indexed for O(1) lookup
  tokenVerifier    String    // Hashed with bcrypt
  token            String?   @unique // DEPRECATED: Keep for migration, nullable
  previousSelector String?   // Previous selector for reuse detection
  previousToken    String?   // DEPRECATED: Previous token hash for rotation detection
  userAgent        String?
  ipAddress        String?
  expiresAt        DateTime
  rotatedAt        DateTime? // Last rotation timestamp
  createdAt        DateTime  @default(now())

  @@index([tokenSelector])
}

// ============================================
// JWT ENHANCEMENT - TOKEN BLACKLIST
// ============================================

model TokenBlacklist {
  id        String   @id @default(cuid())
  tokenHash String   @unique // SHA256 hash of token
  userId    String
  reason    String   // logout, password_change, admin_revoke, security
  expiresAt DateTime // Auto-cleanup after token would expire
  createdAt DateTime @default(now())

  @@index([tokenHash])
  @@index([expiresAt])
  @@index([userId])
}

// ============================================
// JWT ENHANCEMENT - AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  eventType String   // LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, TOKEN_REFRESH, PASSWORD_CHANGE, etc.
  userId    String?
  email     String?
  ipAddress String
  userAgent String
  metadata  String?  // JSON string for additional context
  severity  String   @default("INFO") // INFO, WARNING, CRITICAL
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@index([severity])
}

// ============================================
// CMS - PAGES & SECTIONS
// ============================================

model Page {
  id           String    @id @default(cuid())
  slug         String    @unique
  title        String
  isActive     Boolean   @default(true) // Toggle to temporarily disable page
  headerConfig String?
  footerConfig String?
  sections     Section[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Section {
  id        String   @id @default(cuid())
  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  kind      String
  order     Int
  data      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// MEDIA ASSETS
// ============================================

model MediaAsset {
  id           String   @id @default(cuid())
  url          String
  alt          String?
  caption      String?
  width        Int?
  height       Int?
  size         Int?
  mimeType     String?
  tags         String?
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// BLOG & SEO
// ============================================

model BlogCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  color       String?
  posts       BlogPost[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model BlogPost {
  id            String        @id @default(cuid())
  title         String
  slug          String        @unique
  excerpt       String?
  content       String
  featuredImage String?
  categoryId    String
  category      BlogCategory  @relation(fields: [categoryId], references: [id])
  authorId      String
  author        User          @relation(fields: [authorId], references: [id])
  tags          String?
  status        String        @default("DRAFT")
  isFeatured    Boolean       @default(false)
  publishedAt   DateTime?
  comments      BlogComment[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model BlogComment {
  id        String   @id @default(cuid())
  postId    String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  name      String
  email     String
  content   String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ============================================
// ATH - HẠNG MỤC THI CÔNG (Service Categories)
// ============================================

model ServiceCategory {
  id                 String                              @id @default(cuid())
  name               String                              @unique
  slug               String                              @unique
  description        String?
  icon               String?
  coefficient        Float                               @default(1.0)
  formulaId          String?
  formula            Formula?                            @relation(fields: [formulaId], references: [id])
  materialCategories ServiceCategoryMaterialCategory[]
  order              Int                                 @default(0)
  isActive           Boolean                             @default(true)
  
  // Bidding Phase 2 relations
  projects           Project[]
  
  createdAt          DateTime                            @default(now())
  updatedAt          DateTime                            @updatedAt
}

// ============================================
// ATH - ĐƠN GIÁ THI CÔNG (Unit Prices)
// ============================================

model UnitPrice {
  id          String   @id @default(cuid())
  category    String
  name        String
  price       Float
  tag         String   @unique
  unit        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([tag])
}

// ============================================
// ATH - DANH MỤC VẬT DỤNG (Material Categories)
// ============================================

model MaterialCategory {
  id                String                              @id @default(cuid())
  name              String                              @unique
  slug              String                              @unique
  description       String?
  icon              String?
  order             Int                                 @default(0)
  isActive          Boolean                             @default(true)
  materials         Material[]
  serviceCategories ServiceCategoryMaterialCategory[]
  createdAt         DateTime                            @default(now())
  updatedAt         DateTime                            @updatedAt
}

// ============================================
// ATH - VẬT DỤNG CƠ BẢN (Materials)
// ============================================

model Material {
  id          String            @id @default(cuid())
  name        String
  categoryId  String
  category    MaterialCategory  @relation(fields: [categoryId], references: [id])
  imageUrl    String?
  price       Float
  unit        String?
  description String?
  order       Int               @default(0)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([categoryId])
}

// Junction table for ServiceCategory <-> MaterialCategory (many-to-many)
model ServiceCategoryMaterialCategory {
  id                 String           @id @default(cuid())
  serviceCategoryId  String
  serviceCategory    ServiceCategory  @relation(fields: [serviceCategoryId], references: [id], onDelete: Cascade)
  materialCategoryId String
  materialCategory   MaterialCategory @relation(fields: [materialCategoryId], references: [id], onDelete: Cascade)

  @@unique([serviceCategoryId, materialCategoryId])
  @@index([serviceCategoryId])
  @@index([materialCategoryId])
}

// ============================================
// ATH - CÔNG THỨC TÍNH GIÁ (Formulas)
// ============================================

model Formula {
  id                String            @id @default(cuid())
  name              String
  expression        String
  description       String?
  serviceCategories ServiceCategory[]
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

// ============================================
// ATH - KHÁCH HÀNG / LEADS
// ============================================

model CustomerLead {
  id            String   @id @default(cuid())
  name          String
  phone         String
  email         String?
  content       String
  source        String   @default("CONTACT_FORM")
  status        String   @default("NEW")
  quoteData     String?
  notes         String?
  statusHistory String?  // JSON array of status changes: [{from, to, changedAt, changedBy?}]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([source])
  @@index([createdAt])
}

// ============================================
// ATH - PENDING CHANGES (Phân quyền)
// ============================================

model PendingChange {
  id          String    @id @default(cuid())
  entityType  String
  entityId    String
  changeType  String
  oldData     String?
  newData     String
  reason      String?
  status      String    @default("PENDING")
  requestedBy String
  requester   User      @relation(fields: [requestedBy], references: [id])
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([entityType])
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// INTEGRATIONS (Google Sheets, etc.)
// ============================================

model Integration {
  id          String    @id @default(cuid())
  type        String    @unique // google_sheets, etc.
  config      String    // JSON: { spreadsheetId, sheetName, syncEnabled }
  credentials String?   // Encrypted refresh token
  lastSyncAt  DateTime?
  errorCount  Int       @default(0)
  lastError   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// BIDDING SETTINGS (Singleton)
// ============================================

model BiddingSettings {
  id                  String   @id @default("default")
  
  // Bidding config
  maxBidsPerProject   Int      @default(20)
  defaultBidDuration  Int      @default(7)
  minBidDuration      Int      @default(3)
  maxBidDuration      Int      @default(30)
  
  // Escrow config
  escrowPercentage    Float    @default(10)
  escrowMinAmount     Float    @default(1000000)
  escrowMaxAmount     Float?
  
  // Fees config
  verificationFee     Float    @default(500000)
  winFeePercentage    Float    @default(5)
  
  // Auto-approval
  autoApproveHomeowner Boolean @default(true)
  autoApproveProject   Boolean @default(false)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// ============================================
// SERVICE FEE
// ============================================

model ServiceFee {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  type        String   // FIXED, PERCENTAGE
  value       Float
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([code])
  @@index([isActive])
}

// ============================================
// BIDDING PHASE 2 - PROJECT
// ============================================

model Project {
  id          String   @id @default(cuid())
  code        String   @unique // AUTO: PRJ-2024-001
  
  // Owner relation
  ownerId     String
  owner       User     @relation("ProjectOwner", fields: [ownerId], references: [id])
  
  // Basic info
  title       String
  description String
  categoryId  String
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
  
  // Location
  regionId    String
  region      Region   @relation(fields: [regionId], references: [id])
  address     String   // Hidden until match
  
  // Details
  area        Float?            // Diện tích (m²)
  budgetMin   Float?            // Ngân sách tối thiểu
  budgetMax   Float?            // Ngân sách tối đa
  timeline    String?           // Timeline mong muốn (e.g., "2 tuần", "1 tháng")
  images      String?           // JSON array of URLs (max 10)
  requirements String?          // Yêu cầu đặc biệt
  
  // Status: DRAFT, PENDING_APPROVAL, REJECTED, OPEN, BIDDING_CLOSED, MATCHED, IN_PROGRESS, COMPLETED, CANCELLED
  status      String   @default("DRAFT")
  
  // Admin review
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNote    String?
  
  // Bidding
  bidDeadline   DateTime?
  maxBids       Int       @default(20)
  
  // Match (Phase 3)
  selectedBidId String?   @unique
  selectedBid   Bid?      @relation("SelectedBid", fields: [selectedBidId], references: [id])
  matchedAt     DateTime?
  
  // Relations
  bids          Bid[]     @relation("ProjectBids")
  
  // Phase 3 relations
  escrow           Escrow?
  feeTransactions  FeeTransaction[]
  milestones       ProjectMilestone[]
  
  // Phase 4 relations - Chat
  conversations    Conversation[]
  
  // Phase 5 relations - Reviews
  reviews          Review[]
  
  // Phase 6 relations - Saved Projects
  savedByContractors SavedProject[]
  
  // Timestamps
  publishedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([status])
  @@index([ownerId])
  @@index([regionId])
  @@index([categoryId])
  @@index([bidDeadline])
}

// ============================================
// BIDDING PHASE 2 - BID
// ============================================

model Bid {
  id          String   @id @default(cuid())
  code        String   @unique // AUTO: BID-2024-001
  
  // Relations
  projectId   String
  project     Project  @relation("ProjectBids", fields: [projectId], references: [id])
  contractorId String
  contractor  User     @relation("ContractorBids", fields: [contractorId], references: [id])
  
  // Bid details
  price       Float              // Giá đề xuất
  timeline    String             // Timeline đề xuất (e.g., "10 ngày", "2 tuần")
  proposal    String             // Mô tả đề xuất chi tiết
  attachments String?            // JSON array: [{name, url, type, size}] (max 5 files)
  
  // Response time tracking (Phase 5)
  responseTimeHours Float?       // Time from project publish to bid creation (hours)
  
  // Status: PENDING, APPROVED, REJECTED, SELECTED, NOT_SELECTED, WITHDRAWN
  status      String   @default("PENDING")
  
  // Admin review
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  
  // Selected (Phase 3)
  selectedProject Project? @relation("SelectedBid")
  
  // Phase 3 relations
  escrow          Escrow?
  feeTransactions FeeTransaction[]
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([projectId, contractorId])
  @@index([projectId])
  @@index([contractorId])
  @@index([status])
}

// ============================================
// BIDDING PHASE 3 - ESCROW
// ============================================

model Escrow {
  id          String   @id @default(cuid())
  code        String   @unique // AUTO: ESC-YYYY-NNN
  
  // Relations
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id])
  bidId       String   @unique
  bid         Bid      @relation(fields: [bidId], references: [id])
  homeownerId String   // Người đặt cọc (chủ nhà)
  homeowner   User     @relation("EscrowDepositor", fields: [homeownerId], references: [id])
  
  // Amount
  amount         Float    // Calculated escrow amount
  releasedAmount Float    @default(0) // Số tiền đã giải phóng
  currency       String   @default("VND")
  
  // Status: PENDING, HELD, PARTIAL_RELEASED, RELEASED, REFUNDED, DISPUTED, CANCELLED
  status      String   @default("PENDING")
  
  // Transactions log - JSON: [{type, amount, date, note, adminId}]
  transactions String?
  
  // Milestones
  milestones   ProjectMilestone[]
  
  // Dispute
  disputeReason     String?
  disputedBy        String?  // User who raised dispute
  disputeResolvedAt DateTime?
  disputeResolution String?  // Resolution note
  
  // Admin tracking
  confirmedBy   String?
  confirmedAt   DateTime?
  releasedBy    String?
  releasedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([projectId])
  @@index([homeownerId])
}

// ============================================
// BIDDING PHASE 3 - PROJECT MILESTONE
// ============================================

model ProjectMilestone {
  id          String   @id @default(cuid())
  
  // Relations
  escrowId    String
  escrow      Escrow   @relation(fields: [escrowId], references: [id])
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  
  // Milestone details
  name              String   // "50% Completion", "100% Completion"
  percentage        Int      // 50, 100
  releasePercentage Int      // % of escrow to release at this milestone
  
  // Status: PENDING, REQUESTED, CONFIRMED, DISPUTED
  status      String   @default("PENDING")
  
  // Tracking
  requestedAt   DateTime?  // Contractor requests completion
  requestedBy   String?
  confirmedAt   DateTime?  // Homeowner confirms
  confirmedBy   String?
  disputedAt    DateTime?
  disputeReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([escrowId])
  @@index([projectId])
  @@index([status])
}

// ============================================
// BIDDING PHASE 3 - FEE TRANSACTION
// ============================================

model FeeTransaction {
  id          String   @id @default(cuid())
  code        String   @unique // AUTO: FEE-YYYY-NNN
  
  // Relations
  userId      String   // Contractor who pays
  user        User     @relation(fields: [userId], references: [id])
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  bidId       String
  bid         Bid      @relation(fields: [bidId], references: [id])
  
  // Fee details
  type        String   // WIN_FEE, VERIFICATION_FEE
  amount      Float
  currency    String   @default("VND")
  
  // Status: PENDING, PAID, CANCELLED
  status      String   @default("PENDING")
  
  // Payment tracking
  paidAt      DateTime?
  paidBy      String?  // Admin who marked as paid
  cancelledAt DateTime?
  cancelledBy String?
  cancelReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([userId])
  @@index([type])
  @@index([projectId])
}

// ============================================
// BIDDING PHASE 3 - NOTIFICATION
// ============================================

model Notification {
  id          String   @id @default(cuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  type        String   // BID_SELECTED, BID_NOT_SELECTED, ESCROW_HELD, ESCROW_RELEASED, etc.
  title       String
  content     String
  data        String?  // JSON: { projectId, bidId, etc. }
  
  // Channels - Phase 4 enhancement
  channels    String?  // JSON: ["EMAIL", "SMS", "IN_APP"]
  
  // Delivery status
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  // Email delivery tracking
  emailSent   Boolean  @default(false)
  emailSentAt DateTime?
  emailError  String?
  
  // SMS delivery tracking
  smsSent     Boolean  @default(false)
  smsSentAt   DateTime?
  smsError    String?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// BIDDING PHASE 4 - CHAT SYSTEM
// ============================================

model Conversation {
  id            String   @id @default(cuid())
  projectId     String?  // Optional link to project
  project       Project? @relation(fields: [projectId], references: [id])
  
  participants  ConversationParticipant[]
  messages      Message[]
  
  isClosed      Boolean  @default(false)
  closedAt      DateTime?
  closedBy      String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([projectId])
  @@index([isClosed])
}

model ConversationParticipant {
  id              String       @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  
  lastReadAt      DateTime?
  isActive        Boolean      @default(true)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id              String       @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId        String
  sender          User         @relation(fields: [senderId], references: [id])
  
  content         String
  type            String       @default("TEXT") // TEXT, IMAGE, FILE, SYSTEM
  attachments     String?      // JSON: [{name, url, type, size}]
  
  isRead          Boolean      @default(false)
  readAt          DateTime?
  readBy          String?      // JSON: [{userId, readAt}] for multi-participant tracking
  isDeleted       Boolean      @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime     @default(now())
  
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isDeleted])
}

// ============================================
// BIDDING PHASE 4 - NOTIFICATION PREFERENCES
// ============================================

model NotificationPreference {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Email notifications
  emailEnabled        Boolean @default(true)
  emailBidReceived    Boolean @default(true)
  emailBidApproved    Boolean @default(true)
  emailProjectMatched Boolean @default(true)
  emailNewMessage     Boolean @default(true)
  emailEscrowReleased Boolean @default(true)
  
  // SMS notifications
  smsEnabled          Boolean @default(true)
  smsBidReceived      Boolean @default(false)
  smsBidApproved      Boolean @default(true)
  smsProjectMatched   Boolean @default(true)
  smsNewMessage       Boolean @default(false)
  smsEscrowReleased   Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// BIDDING PHASE 4 - NOTIFICATION TEMPLATES
// ============================================

model NotificationTemplate {
  id          String   @id @default(cuid())
  type        String   @unique // BID_RECEIVED, PROJECT_MATCHED, etc.
  
  // Email template
  emailSubject String
  emailBody    String   // HTML with variables like {{projectCode}}
  
  // SMS template
  smsBody      String   // Plain text, max 160 chars
  
  // In-app template
  inAppTitle   String
  inAppBody    String
  
  // Variables available
  variables    String   // JSON: ["projectCode", "contractorName", "price"]
  
  // Versioning
  version      Int      @default(1)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// BIDDING PHASE 4 - SCHEDULED NOTIFICATIONS
// ============================================

model ScheduledNotification {
  id          String   @id @default(cuid())
  
  type        String   // BID_DEADLINE_REMINDER, NO_BIDS_REMINDER, ESCROW_PENDING
  userId      String
  
  // Reference
  projectId   String?
  escrowId    String?
  
  // Scheduling
  scheduledFor DateTime
  status       String   @default("PENDING") // PENDING, SENT, CANCELLED
  
  sentAt       DateTime?
  cancelledAt  DateTime?
  
  createdAt    DateTime @default(now())
  
  @@index([status, scheduledFor])
  @@index([userId])
  @@index([type])
}

// ============================================
// BIDDING PHASE 5 - REVIEW SYSTEM
// ============================================

model Review {
  id          String   @id @default(cuid())
  
  // Relations
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  reviewerId  String   // Homeowner who writes the review
  reviewer    User     @relation("ReviewAuthor", fields: [reviewerId], references: [id])
  contractorId String  // Contractor being reviewed
  contractor  User     @relation("ReviewSubject", fields: [contractorId], references: [id])
  
  // Rating (1-5)
  rating      Int
  comment     String?
  images      String?  // JSON: ["url1", "url2"] max 5
  
  // Multi-criteria ratings (1-5) - Optional for detailed reviews
  qualityRating       Int?  // Chất lượng công việc
  timelinessRating    Int?  // Đúng tiến độ
  communicationRating Int?  // Giao tiếp
  valueRating         Int?  // Giá cả hợp lý
  
  // Response from contractor
  response    String?
  respondedAt DateTime?
  
  // Visibility
  isPublic    Boolean  @default(true)
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  
  // Helpfulness
  helpfulCount Int     @default(0)
  helpfulVotes ReviewHelpfulness[]
  
  // Reports
  reports     ReviewReport[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([projectId, reviewerId])
  @@index([contractorId])
  @@index([rating])
  @@index([isPublic])
  @@index([isDeleted])
}

// ============================================
// BIDDING PHASE 5 - REVIEW HELPFULNESS
// ============================================

model ReviewHelpfulness {
  id        String   @id @default(cuid())
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([reviewId, userId])
  @@index([reviewId])
}

// ============================================
// BIDDING PHASE 5 - REVIEW REPORT
// ============================================

model ReviewReport {
  id          String   @id @default(cuid())
  reviewId    String
  review      Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporterId  String
  reporter    User     @relation(fields: [reporterId], references: [id])
  
  reason      String   // spam, offensive, fake, irrelevant
  description String?
  status      String   @default("PENDING") // PENDING, RESOLVED, DISMISSED
  
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?  // hide, delete, dismiss
  
  createdAt   DateTime @default(now())
  
  @@index([reviewId])
  @@index([status])
}

// ============================================
// BIDDING PHASE 5 - CONTRACTOR RANKING
// ============================================

model ContractorRanking {
  id              String   @id @default(cuid())
  contractorId    String   @unique
  contractor      User     @relation(fields: [contractorId], references: [id])
  
  // Score components (0-100 each)
  ratingScore     Float    @default(0)      // 40% weight
  projectsScore   Float    @default(0)      // 30% weight
  responseScore   Float    @default(0)      // 15% weight
  verificationScore Float  @default(0)      // 15% weight
  totalScore      Float    @default(0)
  
  // Rank
  rank            Int      @default(0)
  previousRank    Int?
  
  // Featured
  isFeatured      Boolean  @default(false)
  featuredAt      DateTime?
  featuredBy      String?  // Admin who manually featured
  
  // Stats cache
  totalProjects       Int    @default(0)
  completedProjects   Int    @default(0)
  totalReviews        Int    @default(0)
  averageRating       Float  @default(0)
  averageResponseTime Float  @default(0)  // Average response time in hours (Phase 5)
  
  calculatedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([totalScore])
  @@index([rank])
  @@index([isFeatured])
}

// ============================================
// BIDDING PHASE 5 - CONTRACTOR BADGES
// ============================================

model ContractorBadge {
  id           String   @id @default(cuid())
  contractorId String
  contractor   User     @relation(fields: [contractorId], references: [id])
  
  badgeType    String   // ACTIVE_CONTRACTOR, HIGH_QUALITY, FAST_RESPONDER
  awardedAt    DateTime @default(now())
  
  @@unique([contractorId, badgeType])
  @@index([contractorId])
}

// ============================================
// BIDDING PHASE 6 - SAVED PROJECTS
// ============================================

model SavedProject {
  id           String   @id @default(cuid())
  contractorId String
  contractor   User     @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  savedAt      DateTime @default(now())
  
  @@unique([contractorId, projectId])
  @@index([contractorId])
  @@index([projectId])
}


// ============================================
// INTERIOR MODULE - CHỦ ĐẦU TƯ (Developer)
// ============================================

model InteriorDeveloper {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  logo        String?
  description String?
  website     String?
  phone       String?
  email       String?
  address     String?
  
  developments InteriorDevelopment[]
  
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([order])
}

// ============================================
// INTERIOR MODULE - DỰ ÁN (Development)
// ============================================

model InteriorDevelopment {
  id          String   @id @default(cuid())
  developerId String
  developer   InteriorDeveloper @relation(fields: [developerId], references: [id], onDelete: Cascade)
  
  name        String
  code        String   @unique
  slug        String   @unique
  address     String?
  district    String?
  city        String?
  description String?
  thumbnail   String?
  images      String?  // JSON array
  totalBuildings Int?
  totalUnits     Int?
  startYear      Int?
  completionYear Int?
  
  buildings   InteriorBuilding[]
  
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([developerId])
  @@index([isActive])
  @@index([order])
}

// ============================================
// INTERIOR MODULE - TÒA NHÀ (Building)
// ============================================

model InteriorBuilding {
  id            String   @id @default(cuid())
  developmentId String
  development   InteriorDevelopment @relation(fields: [developmentId], references: [id], onDelete: Cascade)
  
  name          String
  code          String
  totalFloors   Int
  startFloor    Int      @default(1)
  endFloor      Int?
  axisLabels    String   // JSON array: ["A","B","C","D"]
  unitsPerFloor Int
  unitCodeFormat String  @default("{building}.{floor}.{axis}")
  specialFloors String?  // JSON array: [{floor, type, note}]
  thumbnail     String?
  floorPlanImage String?
  
  units         InteriorBuildingUnit[]
  
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([developmentId, code])
  @@index([developmentId])
  @@index([isActive])
}

// ============================================
// INTERIOR MODULE - CĂN HỘ THEO TRỤC (Building Unit)
// ============================================

model InteriorBuildingUnit {
  id          String   @id @default(cuid())
  buildingId  String
  building    InteriorBuilding @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  axis        String
  unitType    String   // STUDIO, 1PN, 2PN, 3PN, 4PN, PENTHOUSE, DUPLEX, SHOPHOUSE
  bedrooms    Int
  bathrooms   Int      @default(1)
  position    String   @default("MIDDLE") // CORNER, EDGE, MIDDLE
  direction   String?  // ĐÔNG, TÂY, NAM, BẮC, ĐÔNG_NAM, ĐÔNG_BẮC, TÂY_NAM, TÂY_BẮC
  view        String?  // VIEW_POOL, VIEW_PARK, VIEW_CITY, VIEW_RIVER
  floorStart  Int      @default(1)
  floorEnd    Int?
  layoutId    String
  layout      InteriorUnitLayout @relation(fields: [layoutId], references: [id])
  notes       String?
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([buildingId, axis])
  @@index([buildingId])
  @@index([layoutId])
  @@index([unitType])
}

// ============================================
// INTERIOR MODULE - BẢN VẼ LAYOUT (Unit Layout)
// ============================================

model InteriorUnitLayout {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  unitType    String   // STUDIO, 1PN, 2PN, 3PN, 4PN, PENTHOUSE, DUPLEX, SHOPHOUSE
  bedrooms    Int
  bathrooms   Int      @default(1)
  grossArea   Float    // Diện tích tim tường
  netArea     Float    // Diện tích thông thủy
  carpetArea  Float?   // Diện tích thảm
  balconyArea Float?
  terraceArea Float?
  rooms       String   // JSON array: [{name, area, type}]
  layoutImage     String?  // 2D floor plan
  layout3DImage   String?  // 3D render
  dimensionImage  String?  // Dimension drawing
  description     String?
  highlights      String?  // JSON array: ["2 mặt thoáng", "View hồ bơi"]
  
  buildingUnits   InteriorBuildingUnit[]
  packages        InteriorPackage[]
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([unitType])
  @@index([isActive])
}

// ============================================
// INTERIOR MODULE - GÓI NỘI THẤT (Package)
// ============================================

model InteriorPackage {
  id          String   @id @default(cuid())
  layoutId    String
  layout      InteriorUnitLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  
  name        String
  code        String
  tier        Int      @default(1) // 1: Basic, 2: Standard, 3: Premium, 4: Luxury
  description     String?
  shortDescription String?
  basePrice       Float
  pricePerSqm     Float?
  thumbnail       String?
  images          String?  // JSON array
  video360Url     String?
  items           String   // JSON array: [{room, items: [{name, brand, material, qty, price}]}]
  totalItems      Int?
  totalItemsPrice Float?
  warrantyMonths  Int?
  installationDays Int?
  
  quotes          InteriorQuote[]
  
  order           Int     @default(0)
  isActive        Boolean @default(true)
  isFeatured      Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([layoutId, code])
  @@index([layoutId])
  @@index([tier])
  @@index([isActive])
  @@index([isFeatured])
}

// ============================================
// INTERIOR MODULE - DANH MỤC ĐỒ NỘI THẤT (Furniture Category)
// ============================================

model InteriorFurnitureCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  icon        String?
  description String?
  parentId    String?
  parent      InteriorFurnitureCategory?  @relation("FurnitureCategoryHierarchy", fields: [parentId], references: [id])
  children    InteriorFurnitureCategory[] @relation("FurnitureCategoryHierarchy")
  roomTypes   String?  // JSON array of room type codes
  
  items       InteriorFurnitureItem[]
  
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([parentId])
  @@index([isActive])
  @@index([order])
}

// ============================================
// INTERIOR MODULE - ĐỒ NỘI THẤT (Furniture Item)
// ============================================

model InteriorFurnitureItem {
  id          String   @id @default(cuid())
  categoryId  String
  category    InteriorFurnitureCategory @relation(fields: [categoryId], references: [id])
  
  name        String
  sku         String?  @unique
  brand       String?
  origin      String?
  material    String?
  color       String?
  dimensions  String?  // JSON: {width, height, depth, unit}
  weight      Float?
  price       Float
  costPrice   Float?
  thumbnail   String?
  images      String?  // JSON array
  description String?
  features    String?  // JSON array
  warrantyMonths Int?
  inStock     Boolean  @default(true)
  stockQty    Int?
  
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([categoryId])
  @@index([brand])
  @@index([isActive])
  @@index([inStock])
}

// ============================================
// INTERIOR MODULE - PHỤ PHÍ (Surcharge)
// ============================================

model InteriorSurcharge {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  type        String   // FIXED, PERCENTAGE, PER_FLOOR, PER_SQM, CONDITIONAL
  value       Float
  conditions  String?  // JSON: {minFloor, maxFloor, minArea, maxArea, unitTypes, positions, buildings, developments}
  description String?
  isAutoApply Boolean  @default(true)
  isOptional  Boolean  @default(false)
  
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([type])
  @@index([isActive])
  @@index([isAutoApply])
}

// ============================================
// INTERIOR MODULE - CẤU HÌNH BÁO GIÁ (Quote Settings) - Singleton
// ============================================

model InteriorQuoteSettings {
  id          String   @id @default("default")
  laborCostPerSqm     Float   @default(500000)
  laborCostMin        Float?
  laborCostMax        Float?
  managementFeeType   String  @default("PERCENTAGE") // FIXED, PERCENTAGE
  managementFeeValue  Float   @default(5)
  contingencyType     String  @default("PERCENTAGE") // FIXED, PERCENTAGE
  contingencyValue    Float   @default(3)
  vatEnabled          Boolean @default(true)
  vatPercent          Float   @default(10)
  maxDiscountPercent  Float?  @default(15)
  quoteValidityDays   Int     @default(30)
  customFormula       String?
  showItemBreakdown   Boolean @default(true)
  showRoomBreakdown   Boolean @default(true)
  showPricePerSqm     Boolean @default(true)
  companyName         String?
  companyPhone        String?
  companyEmail        String?
  companyAddress      String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// INTERIOR MODULE - LOẠI PHÒNG (Room Type)
// ============================================

model InteriorRoomType {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  nameEn      String?
  icon        String?
  description String?
  defaultCategories String?  // JSON array of category IDs
  
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([order])
}

// ============================================
// INTERIOR MODULE - BÁO GIÁ (Quote)
// ============================================

model InteriorQuote {
  id          String   @id @default(cuid())
  code        String   @unique // AUTO: INT-YYYY-NNN
  
  // Customer info
  customerName    String
  customerPhone   String
  customerEmail   String?
  
  // Unit info
  developmentName String
  buildingName    String
  unitCode        String
  floor           Int
  axis            String
  unitType        String
  
  // Layout info
  layoutName      String
  grossArea       Float
  netArea         Float
  
  // Package info
  packageId       String
  package         InteriorPackage @relation(fields: [packageId], references: [id])
  packageName     String
  packageTier     Int
  packagePrice    Float
  
  // Calculated costs
  laborCost       Float
  surcharges      String?  // JSON array: [{name, amount}]
  surchargesTotal Float    @default(0)
  managementFee   Float    @default(0)
  contingency     Float    @default(0)
  subtotal        Float
  vatAmount       Float    @default(0)
  discount        Float    @default(0)
  grandTotal      Float
  pricePerSqm     Float?
  
  // Status: DRAFT, SENT, VIEWED, ACCEPTED, REJECTED, EXPIRED
  status          String   @default("DRAFT")
  validUntil      DateTime?
  
  // Notes
  notes           String?
  internalNotes   String?
  
  // Tracking
  sentAt          DateTime?
  viewedAt        DateTime?
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([customerPhone])
  @@index([packageId])
  @@index([createdAt])
}
